name: Staging Build and Submit

on:
  push:
    branches:
      - feat/autodeployment-workflow
  workflow_dispatch:

jobs:
  build:
    name: Build iOS and Android
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: üèó Setup repo
        uses: actions/checkout@v4

      - name: üèó Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: yarn

      - name: üèó Setup EAS
        uses: expo/expo-github-action@c7b66a9c327a43a8fa7c0158e7f30d6040d2481e
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        run: yarn install

      - name: üî® Build Android
        id: build-android
        run: |
          # Build and capture output
          set +e  # Don't exit on error immediately
          BUILD_OUTPUT=$(eas build --platform android --profile staging-android --non-interactive --wait 2>&1)
          BUILD_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          echo "$BUILD_OUTPUT"
          
          # Check if build command failed
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Build command failed with exit code $BUILD_EXIT_CODE"
            echo "Build output:"
            echo "$BUILD_OUTPUT"
            exit $BUILD_EXIT_CODE
          fi
          
          # Extract build ID using multiple methods for reliability
          # Method 1: Extract from URL pattern (builds/xxxxx-xxxxx-xxxxx)
          BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oE 'builds/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -1 | cut -d'/' -f2)
          
          # Method 2: If Method 1 fails, try extracting from JSON output or other patterns
          if [ -z "$BUILD_ID" ]; then
            BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oE '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -1)
          fi
          
          if [ -z "$BUILD_ID" ]; then
            echo "‚ùå Failed to extract build ID from output"
            echo "Build output:"
            echo "$BUILD_OUTPUT"
            exit 1
          fi
          
          echo "‚úÖ Built Android with ID: $BUILD_ID"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

      - name: üì± Submit to Google Play Console
        run: |
          # IMPORTANT: We use --id instead of --latest because --latest doesn't filter by profile
          # It would pick up the most recent build regardless of profile (could be production)
          BUILD_ID="${{ steps.build-android.outputs.build_id }}"
          if [ -z "$BUILD_ID" ]; then
            echo "‚ùå Build ID is empty, cannot submit"
            exit 1
          fi
          echo "üì± Submitting build $BUILD_ID with profile staging-android"
          eas submit --platform android --id "$BUILD_ID" --profile staging-android --non-interactive

      - name: üî® Build iOS
        id: build-ios
        run: |
          # Build and capture output
          set +e  # Don't exit on error immediately
          BUILD_OUTPUT=$(eas build --platform ios --profile staging-ios --non-interactive --wait 2>&1)
          BUILD_EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          echo "$BUILD_OUTPUT"
          
          # Check if build command failed
          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Build command failed with exit code $BUILD_EXIT_CODE"
            echo "Build output:"
            echo "$BUILD_OUTPUT"
            exit $BUILD_EXIT_CODE
          fi
          
          # Extract build ID using multiple methods for reliability
          # Method 1: Extract from URL pattern (builds/xxxxx-xxxxx-xxxxx)
          BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oE 'builds/[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -1 | cut -d'/' -f2)
          
          # Method 2: If Method 1 fails, try extracting from JSON output or other patterns
          if [ -z "$BUILD_ID" ]; then
            BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -oE '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' | head -1)
          fi
          
          if [ -z "$BUILD_ID" ]; then
            echo "‚ùå Failed to extract build ID from output"
            echo "Build output:"
            echo "$BUILD_OUTPUT"
            exit 1
          fi
          
          echo "‚úÖ Built iOS with ID: $BUILD_ID"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT

      - name: üì± Submit to TestFlight
        run: |
          # IMPORTANT: We use --id instead of --latest because --latest doesn't filter by profile
          # It would pick up the most recent build regardless of profile (could be production)
          BUILD_ID="${{ steps.build-ios.outputs.build_id }}"
          if [ -z "$BUILD_ID" ]; then
            echo "‚ùå Build ID is empty, cannot submit"
            exit 1
          fi
          echo "üì± Submitting build $BUILD_ID with profile staging-ios"
          eas submit --platform ios --id "$BUILD_ID" --profile staging-ios --non-interactive
